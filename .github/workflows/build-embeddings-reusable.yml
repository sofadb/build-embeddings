name: Build Embeddings (Reusable)

on:
  workflow_call:
    inputs:
      embeddings_repo:
        description: 'Embeddings repository to push to (e.g., user/brain-embeddings)'
        required: true
        type: string
      notes_path:
        description: 'Path to notes files within the repo'
        required: false
        type: string
        default: '/'
      embeddings_path:
        description: 'Path where embeddings should be output in embeddings repo'
        required: false
        type: string
        default: '/'
      image_tag:
        description: 'Docker image tag to use'
        required: false
        type: string
        default: 'latest'
      commit_email:
        description: 'Email for git commits'
        required: false
        type: string
        default: 'action@github.com'
      commit_user:
        description: 'Name for git commits'
        required: false
        type: string
        default: 'GitHub Action - Embeddings Builder'
    secrets:
      embeddings_token:
        description: 'Token to access and push to the embeddings repo'
        required: true

jobs:
  build-embeddings:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout notes repo
      uses: actions/checkout@v4
      with:
        token: ${{ github.token }}
        path: notes
    
    - name: Checkout embeddings repo
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.embeddings_repo }}
        token: ${{ secrets.embeddings_token }}
        path: embeddings
    
    - name: Checkout embeddings tool repo
      uses: actions/checkout@v4
      with:
        repository: sofadb/build-embeddings
        token: ${{ github.token }}
        path: embeddings-tool
    
    - name: Prepare directories
      run: |
        echo "=== DEBUG: Workspace contents ==="
        ls -la ${{ github.workspace }}
        
        echo "=== DEBUG: Notes repo contents ==="
        ls -la notes/
        
        echo "=== DEBUG: Embeddings repo contents ==="
        ls -la embeddings/
        
        echo "=== DEBUG: Setting up embeddings directory ==="
        mkdir -p work/embeddings
        
        echo "=== DEBUG: Markdown files to process ==="
        find notes/ -name "*.md" -type f 2>/dev/null || echo "No .md files found"
    
    - name: Build embeddings
      run: |
        echo "=== DEBUG: Running Docker container ==="
        echo "Notes path: ${{ github.workspace }}/notes"
        echo "Embeddings path: ${{ github.workspace }}/work/embeddings"
        echo "Image: ghcr.io/sofadb/build-embeddings:${{ inputs.image_tag }}"
        
        docker run --rm \
          -v ${{ github.workspace }}/notes:/docs \
          -v ${{ github.workspace }}/work/embeddings:/embeddings \
          ghcr.io/sofadb/build-embeddings:${{ inputs.image_tag }}
        
        echo "=== DEBUG: Docker container finished ==="
        echo "Generated embeddings:"
        ls -laR work/embeddings/ 2>/dev/null || echo "No embeddings files found"
    
    - name: Copy embeddings to embeddings repo
      run: |
        echo "=== DEBUG: Copying embeddings ==="
        
        if [ "${{ inputs.embeddings_path }}" = "/" ]; then
          cp -r work/embeddings/* embeddings/ 2>/dev/null || echo "No embeddings generated"
        else
          mkdir -p embeddings${{ inputs.embeddings_path }}
          cp -r work/embeddings/* embeddings${{ inputs.embeddings_path }}/ 2>/dev/null || echo "No embeddings generated"
        fi
        
        echo "=== DEBUG: Embeddings repo contents after copy ==="
        ls -la embeddings/
    
    - name: Commit and push embeddings
      run: |
        cd embeddings
        git config --local user.email "${{ inputs.commit_email }}"
        git config --local user.name "${{ inputs.commit_user }}"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ”¢ Update embeddings - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi
